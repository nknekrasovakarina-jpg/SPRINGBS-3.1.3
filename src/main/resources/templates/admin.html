<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark px-3">
    <span class="navbar-text text-white">
        <span th:text="${#request.userPrincipal.principal.username}"></span>
        with roles:
        <span th:text="${#request.userPrincipal.principal.authorities}"></span>
    </span>

    <form action="/logout" method="post">
        <input type="hidden" name="_csrf" th:value="${_csrf.token}">
        <button class="btn btn-outline-light">Logout</button>
    </form>
</nav>

<div class="container-fluid mt-4">

    <div class="row">

        <!-- SIDEBAR -->
        <div class="col-2 bg-white p-3 border-end" style="height: 100vh">
            <button class="btn btn-primary w-100 mb-2">Admin</button>
            <a href="/user" class="btn btn-light w-100">User</a>
        </div>

        <!-- MAIN CONTENT -->
        <div class="col-10">

            <h2>Admin panel</h2>

            <button class="btn btn-success mt-3 mb-3" data-bs-toggle="modal" data-bs-target="#addModal">
                + New User
            </button>

            <!-- USERS TABLE -->
            <table class="table table-striped">
                <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Age</th>
                    <th>Roles</th>
                    <th>Edit</th>
                    <th>Delete</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="u : ${users}">
                    <td th:text="${u.id}"></td>
                    <td th:text="${u.username}"></td>
                    <td th:text="${u.email}"></td>
                    <td th:text="${u.age}"></td>

                    <td>
                        <span th:each="r : ${u.roles}" th:text="${r.name + ' '}"></span>
                    </td>

                    <td>
                        <button class="btn btn-info btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#editModal"
                                th:attr="data-id=${u.id},
                                         data-username=${u.username},
                                         data-email=${u.email},
                                         data-age=${u.age},
                                         data-roles=${u.roles}">
                            Edit
                        </button>
                    </td>

                    <td>
                        <button class="btn btn-danger btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#deleteModal"
                                th:attr="data-id=${u.id},
                                         data-username=${u.username}">
                            Delete
                        </button>
                    </td>

                </tr>
                </tbody>
            </table>

        </div>
    </div>
</div>


<!-- ======================== ADD MODAL ======================== -->
<div class="modal fade" id="addModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="addForm">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">

                <div class="modal-header">
                    <h5 class="modal-title">Add new user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <label>Username</label>
                    <input name="username" class="form-control mb-3" required>

                    <label>Email</label>
                    <input name="email" class="form-control mb-3" required>

                    <label>Age</label>
                    <input name="age" type="number" class="form-control mb-3">

                    <label>Password</label>
                    <input name="password" type="password" class="form-control mb-3" required>

                    <label>Roles</label>
                    <select name="roleIds" multiple class="form-select">
                        <option th:each="r : ${roles}" th:value="${r.id}" th:text="${r.name}"></option>
                    </select>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-success" id="addSubmit">Add user</button>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- ======================== EDIT MODAL ======================== -->
<div class="modal fade" id="editModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="editForm">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
                <input type="hidden" name="id" id="edit-id">

                <div class="modal-header">
                    <h5 class="modal-title">Edit user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">

                    <label>Username</label>
                    <input name="username" id="edit-username" class="form-control mb-3">

                    <label>Email</label>
                    <input name="email" id="edit-email" class="form-control mb-3">

                    <label>Age</label>
                    <input name="age" id="edit-age" class="form-control mb-3">

                    <label>Password (optional)</label>
                    <input name="password" type="password" class="form-control mb-3">

                    <label>Roles</label>
                    <select name="roleIds" class="form-select" id="edit-roles" multiple>
                        <option th:each="r : ${roles}" th:value="${r.id}" th:text="${r.name}"></option>
                    </select>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="editSubmit">Save</button>
                </div>

            </form>

        </div>
    </div>
</div>


<!-- ======================== DELETE MODAL ======================== -->
<div class="modal fade" id="deleteModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <form id="deleteForm">
                <input type="hidden" name="_csrf" th:value="${_csrf.token}">
                <input type="hidden" name="id" id="delete-id">

                <div class="modal-header">
                    <h5 class="modal-title">Delete user</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>Delete user: <b id="delete-username"></b>?</p>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="deleteSubmit">Delete</button>
                </div>

            </form>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // ======================== FILL EDIT MODAL ========================
    const editModal = document.getElementById("editModal");

    editModal.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;

        document.getElementById("edit-id").value = button.getAttribute("data-id");
        document.getElementById("edit-username").value = button.getAttribute("data-username");
        document.getElementById("edit-email").value = button.getAttribute("data-email");
        document.getElementById("edit-age").value = button.getAttribute("data-age");
    });

    // ======================== FILL DELETE MODAL ========================
    const deleteModal = document.getElementById("deleteModal");
    deleteModal.addEventListener("show.bs.modal", event => {
        const button = event.relatedTarget;

        let id = button.getAttribute("data-id");
        let username = button.getAttribute("data-username");

        document.getElementById("delete-id").value = id;
        document.getElementById("delete-username").innerText = username;
    });

    // ======================== AJAX ADD USER ========================
    document.getElementById("addSubmit").onclick = async () => {
        let formData = new FormData(document.getElementById("addForm"));

        const response = await fetch("/admin/create", {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById("addModal")).hide();
            location.reload();
        }
    };

    // ======================== AJAX EDIT USER ========================
    document.getElementById("editSubmit").onclick = async () => {
        let id = document.getElementById("edit-id").value;
        let formData = new FormData(document.getElementById("editForm"));

        const response = await fetch(`/admin/update/${id}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById("editModal")).hide();
            location.reload();
        }
    };

    // ======================== AJAX DELETE USER ========================
    document.getElementById("deleteSubmit").onclick = async () => {
        let id = document.getElementById("delete-id").value;
        let formData = new FormData(document.getElementById("deleteForm"));

        const response = await fetch(`/admin/delete/${id}`, {
            method: 'POST',
            body: formData
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
            location.reload();
        }
    };
</script>

</body>
</html>